{"version":3,"sources":["codeGenerator.ts"],"names":[],"mappings":"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","file":"codeGenerator.js","sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n * See LICENSE in the project root for license information.\r\n */\r\n\r\nimport { EOL } from 'os';\r\nimport {\r\n  ISetWebpackPublicPathOptions,\r\n  SetWebpackPublicPathLoader\r\n} from './SetWebpackPublicPathLoader';\r\nimport * as uglify from 'uglify-js';\r\n\r\nexport interface IInternalOptions extends ISetWebpackPublicPathOptions {\r\n  webpackPublicPathVariable?: string;\r\n  regexName?: string;\r\n  linePrefix?: string;\r\n}\r\n\r\nexport function getSetPublicPathCode(options: IInternalOptions, emitWarning: (warning: string) => void): string {\r\n  if (!options.webpackPublicPathVariable) {\r\n    throw '\"webpackPublicPathVariable\" option must be defined.';\r\n  }\r\n\r\n  let lines: string[] = [];\r\n  if (options.regexName) {\r\n    // Double-escape backslashes to make them show up as single backslashes in regexps.\r\n    const escapedRegex: string = options.regexName.replace(/\\\\/, '\\\\\\\\');\r\n\r\n    lines = [\r\n      `var scripts = document.getElementsByTagName('script');`\r\n    ];\r\n\r\n    const regexInitializationSnippet: string = `new RegExp('${escapeSingleQuotes(escapedRegex)}', 'i')`;\r\n    const regexVarName: string | undefined = options.regexVariable;\r\n    if (options.regexVariable) {\r\n      lines.push(...[\r\n        `var regex = (typeof ${regexVarName} !== 'undefined') ? ${regexVarName} : ${regexInitializationSnippet};`\r\n      ]);\r\n    } else {\r\n      lines.push(...[\r\n        `var regex = ${regexInitializationSnippet};`\r\n      ]);\r\n    }\r\n\r\n    lines.push(...[\r\n      'var found = false;',\r\n      '',\r\n      'if (scripts && scripts.length) {',\r\n      '  for (var i = 0; i < scripts.length; i++) {',\r\n      '    if (!scripts[i]) continue;',\r\n      `    var path = scripts[i].getAttribute('src');`,\r\n      '    if (path && path.match(regex)) {',\r\n      `      ${options.webpackPublicPathVariable} = path.substring(0, path.lastIndexOf('/') + 1);`,\r\n      '      found = true;',\r\n      '      break;',\r\n      '    }',\r\n      '  }',\r\n      '}',\r\n      '',\r\n      'if (!found) {',\r\n      `  for (var global in ${SetWebpackPublicPathLoader.registryVarName}) {`,\r\n      '    if (global && global.match(regex)) {',\r\n      `      ${options.webpackPublicPathVariable} = global.substring(0, global.lastIndexOf('/') + 1);`,\r\n      '      break;',\r\n      '    }',\r\n      '  }',\r\n      '}'\r\n    ]);\r\n  } else {\r\n    if (options.publicPath) {\r\n      lines = [\r\n        `var publicPath = '${appendSlashAndEscapeSingleQuotes(options.publicPath)}';`\r\n      ];\r\n    } else if (options.systemJs) {\r\n      lines = [\r\n        `var publicPath = window.System ? window.System.baseURL || '' : '';`,\r\n        `if (publicPath !== '' && publicPath.substr(-1) !== '/') publicPath += '/';`\r\n      ];\r\n    } else {\r\n      emitWarning(`Neither 'publicPath' nor 'systemJs' is defined, so the public path will not be modified`);\r\n\r\n      return '';\r\n    }\r\n\r\n    if (options.urlPrefix && options.urlPrefix !== '') {\r\n      lines.push(\r\n        '',\r\n        `publicPath += '${appendSlashAndEscapeSingleQuotes(options.urlPrefix)}';`);\r\n    }\r\n\r\n    lines.push(\r\n      '',\r\n      `${options.webpackPublicPathVariable} = publicPath;`\r\n    );\r\n  }\r\n\r\n  return joinLines(lines, options.linePrefix);\r\n}\r\n\r\nexport function getGlobalRegisterCode(debug: boolean = false): string {\r\n    const lines: string[] = [\r\n      '(function(){',\r\n      `if (!${SetWebpackPublicPathLoader.registryVarName}) ${SetWebpackPublicPathLoader.registryVarName}={};`,\r\n      `var scripts = document.getElementsByTagName('script');`,\r\n      'if (scripts && scripts.length) {',\r\n      '  for (var i = 0; i < scripts.length; i++) {',\r\n      '    if (!scripts[i]) continue;',\r\n      `    var path = scripts[i].getAttribute('src');`,\r\n      `    if (path) ${SetWebpackPublicPathLoader.registryVarName}[path]=true;`,\r\n      '  }',\r\n      '}',\r\n      '})();'\r\n    ];\r\n\r\n    const joinedScript: string = joinLines(lines);\r\n\r\n    if (debug) {\r\n      return `${EOL}${joinedScript}`;\r\n    } else {\r\n      const uglified: uglify.AST_Toplevel = uglify.parse(joinedScript);\r\n      uglified.figure_out_scope();\r\n      const compressor: uglify.AST_Toplevel = uglify.Compressor({\r\n        dead_code: true\r\n      });\r\n      const compressed: uglify.AST_Toplevel = uglified.transform(compressor);\r\n      compressed.figure_out_scope();\r\n      compressed.compute_char_frequency();\r\n      compressed.mangle_names();\r\n      return `${EOL}${compressed.print_to_string()}`;\r\n    }\r\n  }\r\n\r\nfunction joinLines(lines: string[], linePrefix?: string): string {\r\n  return lines.map((line: string) => {\r\n    if (!!line) {\r\n      return `${linePrefix || ''}${line}`;\r\n    } else {\r\n      return line;\r\n    }\r\n  }).join(EOL).replace(new RegExp(`${EOL}${EOL}+`, 'g'), `${EOL}${EOL}`);\r\n}\r\n\r\nfunction escapeSingleQuotes(str: string): string | undefined {\r\n  if (str) {\r\n    return str.replace('\\'', '\\\\\\'');\r\n  } else {\r\n    return undefined;\r\n  }\r\n}\r\n\r\nfunction appendSlashAndEscapeSingleQuotes(str: string): string | undefined {\r\n  if (str && str.substr(-1) !== '/') {\r\n    str = str + '/';\r\n  }\r\n\r\n  return escapeSingleQuotes(str);\r\n}\r\n"],"sourceRoot":"..\\src"}